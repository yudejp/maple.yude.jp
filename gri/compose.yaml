services:
  gri:
    hostname: gri
    build:
      context: .
    image: gri:local
    container_name: gri
    restart: always
    environment:
      - RUBYOPT=-r/usr/local/gri/patches/ltsv_frozen_fix
      - TZ=Asia/Tokyo
    ports:
      - "9292:9292"
    user: root
    volumes:
      - ./gritab:/usr/local/gri/gritab:ro
      - ./patches/ltsv_frozen_fix.rb:/usr/local/gri/patches/ltsv_frozen_fix.rb:ro
      - ./tra:/usr/local/gri/tra
      - ./gra:/usr/local/gri/gra
    extra_hosts:
      - "nc9300w.ibr1.yude.jp:192.168.1.19"
      - "mf720c.ibr1.yude.jp:192.168.1.11"
      - "gateway.local.kusaremkn.com:172.20.255.254"
      - "SHINTRANET-IX2215.shinanomai.xyz:172.16.0.254"
      - "hnd2sh1.tun.y2e.org:100.76.111.80"
      - "wabi1750ps.nja1.sgchsgch.net:100.113.233.68"
    command:
      - sh
      - -lc
      - |
        set -eu
        /usr/local/bundle/bin/grapher -h 0.0.0.0 -p 9292 &
        web_pid=$$!
        trap 'kill "$$web_pid" 2>/dev/null || true; exit 0' INT TERM
        while true; do
          if ! kill -0 "$$web_pid" 2>/dev/null; then
            echo "grapher exited" >&2
            exit 1
          fi
          /usr/local/bundle/bin/gri
          sleep "$${GRI_INTERVAL:-300}"
        done
  cloudflared:
    image: cloudflare/cloudflared:latest
    user: root
    restart: always
    command: tunnel --no-autoupdate run --token $CLOUDFLARED_TOKEN
